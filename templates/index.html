<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Security Command Center</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-1: #070f1b;
      --bg-2: #0f1b2c;
      --bg-3: #13243a;
      --panel: rgba(9, 18, 32, 0.82);
      --panel-strong: rgba(12, 24, 42, 0.95);
      --line: rgba(56, 189, 248, 0.24);
      --line-soft: rgba(148, 163, 184, 0.22);
      --text: #e0eeff;
      --muted: #9db0ca;
      --danger: #fb7185;
      --ok: #34d399;
      --warn: #fbbf24;
      --info: #38bdf8;
      --vio: #8b5cf6;
      --shadow: 0 20px 50px rgba(2, 6, 23, 0.5);
      --shadow-soft: 0 12px 30px rgba(2, 6, 23, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 8% -18%, rgba(56, 189, 248, 0.24), transparent 42%),
        radial-gradient(circle at 95% -15%, rgba(14, 165, 233, 0.2), transparent 39%),
        linear-gradient(180deg, var(--bg-3), var(--bg-2) 36%, var(--bg-1));
      min-height: 100vh;
    }
    .shell {
      max-width: 1620px;
      margin: 0 auto;
      padding: 22px 20px 56px;
      animation: fadeIn 380ms ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
      border: 1px solid var(--line-soft);
      border-radius: 18px;
      background: linear-gradient(100deg, rgba(9, 18, 32, 0.78), rgba(12, 24, 42, 0.88));
      box-shadow: var(--shadow-soft);
      padding: 14px 16px;
    }
    .title { font-size: 1.72rem; font-weight: 700; letter-spacing: 0.2px; line-height: 1.1; }
    .subtitle { color: var(--muted); font-size: 0.86rem; letter-spacing: 0.18px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .chip {
      background: rgba(8, 15, 28, 0.7);
      border: 1px solid var(--line-soft);
      border-radius: 999px;
      font-size: 0.74rem;
      color: #b8c8de;
      padding: 6px 11px;
      letter-spacing: 0.2px;
    }
    .chip.live::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background: #34d399;
      box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.75);
      animation: pulse 2s infinite;
      vertical-align: middle;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.75); }
      70% { box-shadow: 0 0 0 11px rgba(52, 211, 153, 0); }
      100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); }
    }
    .btn {
      background: linear-gradient(180deg, rgba(24, 39, 62, 0.95), rgba(13, 24, 40, 0.95));
      color: var(--text);
      border: 1px solid rgba(56, 189, 248, 0.34);
      border-radius: 12px;
      font-weight: 600;
      padding: 10px 13px;
      cursor: pointer;
      transition: transform 140ms ease, filter 140ms ease, box-shadow 140ms ease;
    }
    .btn:hover {
      filter: brightness(1.09);
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(2, 132, 199, 0.25);
    }

    .controls {
      display: grid;
      grid-template-columns: minmax(250px, 1fr) 190px 140px auto;
      gap: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--line-soft);
      border-radius: 16px;
      background: linear-gradient(130deg, rgba(7, 17, 30, 0.76), rgba(10, 20, 36, 0.85));
      box-shadow: var(--shadow-soft);
      padding: 10px;
    }
    .controls-advanced {
      display: grid;
      grid-template-columns: repeat(6, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
      border: 1px solid var(--line-soft);
      border-radius: 16px;
      background: linear-gradient(130deg, rgba(7, 17, 30, 0.72), rgba(10, 20, 36, 0.82));
      box-shadow: var(--shadow-soft);
      padding: 10px;
    }
    .input, .select {
      width: 100%;
      border: 1px solid var(--line-soft);
      border-radius: 12px;
      background: rgba(7, 15, 27, 0.9);
      color: var(--text);
      padding: 10px 12px;
      min-height: 42px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 0.9rem;
    }
    .input:focus, .select:focus {
      outline: none;
      border-color: rgba(56, 189, 248, 0.6);
      box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.12);
    }
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line-soft);
      border-radius: 12px;
      background: rgba(7, 15, 27, 0.9);
      padding: 10px 12px;
      color: var(--text);
      font-size: 0.84rem;
      min-height: 42px;
    }
    .toggle input { accent-color: #22d3ee; }

    .kpis {
      display: grid;
      grid-template-columns: repeat(7, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }
    .kpis .card:nth-child(1) { border-color: rgba(251, 113, 133, 0.34); }
    .kpis .card:nth-child(2) { border-color: rgba(52, 211, 153, 0.34); }
    .kpis .card:nth-child(3) { border-color: rgba(251, 191, 36, 0.34); }
    .kpis .card:nth-child(4) { border-color: rgba(56, 189, 248, 0.34); }
    .card {
      border: 1px solid var(--line-soft);
      background:
        linear-gradient(155deg, rgba(12, 25, 43, 0.94), rgba(8, 16, 30, 0.9));
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px;
      backdrop-filter: blur(4px);
      position: relative;
      overflow: hidden;
    }
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(125deg, rgba(56, 189, 248, 0.08), transparent 36%);
      pointer-events: none;
    }
    .k-label { color: var(--muted); font-size: 0.77rem; margin-bottom: 5px; letter-spacing: 0.2px; }
    .k-value { font-size: 1.54rem; font-weight: 700; }

    .grid-main { display: grid; grid-template-columns: 2fr 1.2fr; gap: 10px; margin-bottom: 10px; }
    .grid-mid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .panel-title {
      font-size: 0.95rem;
      font-weight: 650;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      letter-spacing: 0.12px;
    }
    .chart { width: 100%; height: 320px; }
    .chart.short { height: 280px; }

    .table-wrap { overflow: auto; max-height: 560px; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
    th, td { border-bottom: 1px solid rgba(148, 163, 184, 0.14); padding: 9px 8px; text-align: left; vertical-align: middle; }
    th {
      color: #adc0d9;
      font-weight: 600;
      position: sticky;
      top: 0;
      background: rgba(5, 14, 26, 0.96);
      backdrop-filter: blur(4px);
    }
    tr:hover td { background: rgba(56, 189, 248, 0.09); }
    .ban-list {
      max-height: 220px;
      overflow: auto;
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 12px;
    }
    .ban-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
    .ban-table th, .ban-table td { padding: 7px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.14); }
    .ban-table th { position: sticky; top: 0; background: rgba(5, 14, 26, 0.96); color: #adc0d9; }
    .status-pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.72rem;
      font-weight: 600;
      border: 1px solid rgba(148, 163, 184, 0.24);
    }
    .status-pill.live { color: #fecaca; background: rgba(251, 113, 133, 0.18); border-color: rgba(251, 113, 133, 0.35); }
    .status-pill.old { color: #bfdbfe; background: rgba(56, 189, 248, 0.14); border-color: rgba(56, 189, 248, 0.3); }
    .btn-mini {
      font-size: 0.74rem;
      border-radius: 9px;
      padding: 4px 7px;
      border: 1px solid rgba(251, 191, 36, 0.42);
      background: rgba(251, 191, 36, 0.14);
      color: #fde68a;
      cursor: pointer;
    }
    .btn-mini:disabled { opacity: 0.5; cursor: not-allowed; }

    .mono { font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 0.78rem; }
    .pill {
      display: inline-block;
      border: 1px solid var(--line-soft);
      border-radius: 999px;
      font-size: 0.72rem;
      padding: 3px 8px;
      white-space: nowrap;
    }
    .attack { color: var(--danger); background: rgba(251, 113, 133, 0.12); }
    .connection { color: var(--ok); background: rgba(52, 211, 153, 0.12); }
    .info { color: var(--warn); background: rgba(251, 191, 36, 0.12); }
    .country-cell { display: inline-flex; align-items: center; gap: 8px; }
    .flag-icon {
      width: 18px;
      height: 13px;
      border-radius: 3px;
      border: 1px solid rgba(148, 163, 184, 0.38);
      object-fit: cover;
      background: rgba(148, 163, 184, 0.2);
      flex-shrink: 0;
    }
    .threat {
      min-width: 54px;
      text-align: center;
      font-weight: 700;
      color: #081016;
      border-radius: 999px;
      padding: 3px 6px;
      font-size: 0.72rem;
      display: inline-block;
    }
    .ip-btn {
      background: none;
      border: none;
      color: var(--info);
      cursor: pointer;
      padding: 0;
      font: inherit;
      text-decoration: underline;
      text-underline-offset: 2px;
      text-decoration-color: rgba(56, 189, 248, 0.35);
    }

    .drawer {
      position: fixed;
      right: 0;
      top: 0;
      width: min(760px, 96vw);
      height: 100vh;
      background: rgba(6, 11, 20, 0.985);
      border-left: 1px solid rgba(56, 189, 248, 0.22);
      box-shadow: -30px 0 70px rgba(0, 0, 0, 0.58);
      transform: translateX(100%);
      transition: transform 0.28s ease;
      z-index: 20;
      padding: 16px;
      overflow-y: auto;
    }
    .drawer.open { transform: translateX(0); }
    .drawer-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .drawer-grid { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    .drawer pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 0.76rem;
      color: #bdcff1;
    }

    @media (max-width: 1280px) {
      .kpis { grid-template-columns: repeat(4, minmax(120px, 1fr)); }
      .grid-main, .grid-mid { grid-template-columns: 1fr; }
      .controls { grid-template-columns: 1fr; }
      .controls-advanced { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 760px) {
      .shell { padding: 12px 10px 34px; }
      .topbar { padding: 10px; border-radius: 14px; }
      .title { font-size: 1.3rem; }
      .controls-advanced { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      .chart, .chart.short { height: 250px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div>
        <div class="title">Security Command Center</div>
        <div class="subtitle">Geo Heatmap, ASN Intelligence, IOC/Threat Match und IP-Drilldown</div>
      </div>
      <div class="row">
        <span class="chip">ENV: PROD</span>
        <span class="chip live">Live Feed</span>
        <span class="chip" id="activeFilter">Scope: Global</span>
        <span class="chip" id="lastUpdate">Update: -</span>
        <button id="refreshBtn" class="btn">Refresh</button>
      </div>
    </div>

    <div class="controls">
      <input id="search" class="input" placeholder="Suche IP, Pfad, User-Agent, Action..." />
      <select id="category" class="select">
        <option value="all">Alle Kategorien</option>
        <option value="attack">Attack</option>
        <option value="connection">Connection</option>
        <option value="info">Info</option>
      </select>
      <select id="window" class="select">
        <option value="1">1h</option>
        <option value="6">6h</option>
        <option value="24" selected>24h</option>
        <option value="168">7d</option>
      </select>
      <button id="applyBtn" class="btn">Apply Filters</button>
    </div>
    <div class="controls-advanced">
      <label class="toggle"><input type="checkbox" id="compareToggle" /> Compare Prev</label>
      <label class="toggle"><input type="checkbox" id="normalizeToggle" /> Normalize Rate</label>
      <select id="timelineMode" class="select">
        <option value="line">Timeline: Line</option>
        <option value="stacked">Timeline: Stacked</option>
      </select>
      <select id="mapMode" class="select">
        <option value="both">Map: Arcs + Heat</option>
        <option value="arcs">Map: Arcs</option>
        <option value="heat">Map: Heat</option>
      </select>
      <select id="mapTopN" class="select">
        <option value="10">Map Top 10</option>
        <option value="25">Map Top 25</option>
        <option value="50" selected>Map Top 50</option>
      </select>
      <label class="toggle"><input type="checkbox" id="replayToggle" /> Replay Map</label>
    </div>

    <div class="kpis">
      <div class="card"><div class="k-label">Angriffe</div><div id="kAttacks" class="k-value" style="color:var(--danger)">0</div></div>
      <div class="card"><div class="k-label">Verbindungen</div><div id="kConnections" class="k-value" style="color:var(--ok)">0</div></div>
      <div class="card"><div class="k-label">Bans</div><div id="kBans" class="k-value" style="color:var(--warn)">0</div></div>
      <div class="card"><div class="k-label">Aktive Quellen</div><div id="kSources" class="k-value" style="color:var(--info)">0</div></div>
      <div class="card"><div class="k-label">Web Requests</div><div id="kWeb" class="k-value" style="color:var(--vio)">0</div></div>
      <div class="card"><div class="k-label">Top Threat</div><div id="kThreat" class="k-value" style="color:#fb7185">0</div></div>
      <div class="card"><div class="k-label">Top ASN</div><div id="kAsn" class="k-value" style="color:#93c5fd">-</div></div>
    </div>

    <div class="card" style="margin-bottom: 10px;">
      <div class="panel-title"><span>Ban Control (Fail2Ban)</span><span class="subtitle" id="banMeta">Loading...</span></div>
      <div class="ban-list">
        <table class="ban-table">
          <thead>
            <tr>
              <th>IP</th>
              <th>Status</th>
              <th>Last Ban</th>
              <th>Count</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="banRows"></tbody>
        </table>
      </div>
    </div>

    <div class="grid-main">
      <div class="card">
        <div class="panel-title"><span>Traffic Timeline</span><span class="subtitle">Attack vs Connection vs Web</span></div>
        <div id="timelineChart" class="chart"></div>
      </div>
      <div class="card">
        <div class="panel-title"><span>Global Source Map</span><span class="subtitle">Events je Land</span></div>
        <div id="geoChart" class="chart"></div>
      </div>
    </div>

    <div class="grid-mid">
      <div class="card">
        <div class="panel-title"><span>Top ASN (Traffic + Attack)</span><span class="subtitle">Provider-Konzentration</span></div>
        <div id="asnChart" class="chart short"></div>
      </div>
      <div class="card">
        <div class="panel-title"><span>Top Source IPs (Threat Overlay)</span><span class="subtitle">Klick auf IP f√ºr Drilldown</span></div>
        <div id="ipChart" class="chart short"></div>
      </div>
    </div>

    <div class="card">
      <div class="panel-title"><span>Live Event Feed</span><span class="subtitle">inkl. Threat Score, ASN, IOC Labels</span></div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Zeit (UTC)</th>
              <th>Cat</th>
              <th>Country</th>
              <th>IP</th>
              <th>ASN</th>
              <th>Threat</th>
              <th>Action</th>
              <th>Path</th>
              <th>User Agent</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div>
        <div class="title" style="font-size:1.1rem" id="dIp">IP Drilldown</div>
        <div class="subtitle" id="dMeta">-</div>
      </div>
      <button class="btn" id="closeDrawer">Close</button>
    </div>

    <div class="kpis" style="grid-template-columns: repeat(4, minmax(110px, 1fr));">
      <div class="card"><div class="k-label">Events</div><div id="dTotal" class="k-value" style="font-size:1.2rem">0</div></div>
      <div class="card"><div class="k-label">Attacks</div><div id="dAttacks" class="k-value" style="font-size:1.2rem;color:var(--danger)">0</div></div>
      <div class="card"><div class="k-label">Bans</div><div id="dBans" class="k-value" style="font-size:1.2rem;color:var(--warn)">0</div></div>
      <div class="card"><div class="k-label">Threat</div><div id="dThreat" class="k-value" style="font-size:1.2rem;color:#f87171">0</div></div>
    </div>

    <div class="card" style="margin-bottom:10px;">
      <div class="panel-title">Timeline</div>
      <div id="dTimeline" class="chart short"></div>
    </div>

    <div class="drawer-grid">
      <div class="card">
        <div class="panel-title">Actions</div>
        <div id="dActions" class="chart short"></div>
      </div>
      <div class="card">
        <div class="panel-title">Status Codes</div>
        <div id="dStatus" class="chart short"></div>
      </div>
    </div>

    <div class="drawer-grid" style="margin-top:10px;">
      <div class="card">
        <div class="panel-title">Top Paths</div>
        <pre id="dPaths">-</pre>
      </div>
      <div class="card">
        <div class="panel-title">User Agents</div>
        <pre id="dUa">-</pre>
      </div>
    </div>

    <div class="card" style="margin-top:10px;">
      <div class="panel-title">Threat Labels</div>
      <pre id="dLabels">-</pre>
    </div>
  </aside>

<script>
const severity = {
  low: '#86efac',
  medium: '#facc15',
  high: '#f59e0b',
  critical: '#fb7185'
};

const state = {
  hours: 24,
  category: 'all',
  q: '',
  compare: false,
  normalize: false,
  timelineMode: 'line',
  mapMode: 'both',
  mapTopN: 50,
  replay: false,
  replayBucket: 30,
  country: '',
  ip: ''
};

const cache = {
  summary: null,
  geo: null,
  bans: null,
  replayTimer: null,
  replayIndex: 0
};

let timelineChart, geoChart, asnChart, ipChart;
let dTimelineChart, dActionsChart, dStatusChart;

function esc(v) {
  return String(v ?? '').replace(/[&<>\"]/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'}[c]));
}

function ccClean(cc) {
  const c = String(cc || '').trim().toUpperCase();
  return /^[A-Z]{2}$/.test(c) ? c : '';
}

function flagIconHtml(cc, title = '') {
  const c = ccClean(cc);
  if (!c || c === 'PR') return '<span style="font-size:11px;color:#94a3b8">--</span>';
  return `<img class="flag-icon" src="https://flagcdn.com/24x18/${c.toLowerCase()}.png" alt="${c}" title="${esc(title || c)}" loading="lazy" onerror="this.style.display='none'" />`;
}

function threatColor(score) {
  const s = Number(score || 0);
  if (s >= 80) return severity.critical;
  if (s >= 55) return severity.high;
  if (s >= 30) return severity.medium;
  return severity.low;
}

function setText(id, v) {
  const el = document.getElementById(id);
  if (el) el.textContent = v ?? '-';
}

function updateScopeChip() {
  const parts = [];
  if (state.country) parts.push(`Country: ${state.country}`);
  if (state.ip) parts.push(`IP: ${state.ip}`);
  document.getElementById('activeFilter').textContent = parts.length ? `Scope: ${parts.join(' | ')}` : 'Scope: Global';
}

function summaryUrl() {
  const p = new URLSearchParams({
    hours: String(state.hours),
    category: state.category,
    q: state.q,
    limit: '180',
    compare: state.compare ? '1' : '0',
    country: state.country,
    ip: state.ip
  });
  return '/api/summary?' + p.toString();
}

function geoUrl() {
  const p = new URLSearchParams({
    hours: String(state.hours),
    category: state.category,
    q: state.q,
    topn: String(state.mapTopN),
    replay_bucket: String(state.replayBucket),
    country: state.country,
    ip: state.ip
  });
  return '/api/geo?' + p.toString();
}

function bansUrl() {
  return '/api/bans?jail=sshd';
}

function commonAxis() {
  return {
    axisLine: { lineStyle: { color: 'rgba(148,163,184,0.4)' } },
    axisLabel: { color: '#9fb3cf' },
    splitLine: { lineStyle: { color: 'rgba(148,163,184,0.12)' } }
  };
}

function collectLngLatPairs(node, out) {
  if (!Array.isArray(node)) return;
  if (node.length >= 2 && typeof node[0] === 'number' && typeof node[1] === 'number') {
    out.push([node[0], node[1]]);
    return;
  }
  for (const x of node) collectLngLatPairs(x, out);
}

function buildCountryCenterMap() {
  const mapObj = echarts.getMap && echarts.getMap('world');
  const features = mapObj?.geoJSON?.features || [];
  const centers = {};
  for (const f of features) {
    const name = f?.properties?.name;
    if (!name) continue;
    const pts = [];
    collectLngLatPairs(f?.geometry?.coordinates, pts);
    if (!pts.length) continue;
    let minLon = 180, maxLon = -180, minLat = 90, maxLat = -90;
    for (const p of pts) {
      const lon = Number(p[0]);
      const lat = Number(p[1]);
      if (!Number.isFinite(lon) || !Number.isFinite(lat)) continue;
      minLon = Math.min(minLon, lon);
      maxLon = Math.max(maxLon, lon);
      minLat = Math.min(minLat, lat);
      maxLat = Math.max(maxLat, lat);
    }
    if (minLon <= maxLon && minLat <= maxLat) {
      centers[name] = [(minLon + maxLon) / 2, (minLat + maxLat) / 2];
    }
  }
  return centers;
}

function normalizeTimelineRows(rows, bucketMinutes) {
  if (!state.normalize) return rows;
  const div = Math.max(1, Number(bucketMinutes || 1));
  return (rows || []).map(x => ({
    ...x,
    attacks: Number(x.attacks || 0) / div,
    connections: Number(x.connections || 0) / div,
    web: Number(x.web || 0) / div
  }));
}

function seriesFromTimeline(rows, key, fallback = 0) {
  return (rows || []).map(x => Number(x[key] || fallback));
}

function alignCompareTimeline(curr, prev, key) {
  const prevVals = seriesFromTimeline(prev, key, 0);
  const targetLen = (curr || []).length;
  if (prevVals.length === targetLen) return prevVals;
  if (!targetLen) return [];
  const out = new Array(targetLen).fill(0);
  for (let i = 0; i < targetLen; i++) {
    const src = Math.floor((i / Math.max(1, targetLen - 1)) * Math.max(0, prevVals.length - 1));
    out[i] = Number(prevVals[src] || 0);
  }
  return out;
}

function renderTimeline(payload) {
  const timeline = normalizeTimelineRows(payload.timeline || [], payload.window?.bucket_minutes);
  const compareTimeline = normalizeTimelineRows(payload.compare?.timeline || [], payload.window?.bucket_minutes);
  const xSlots = timeline.map(x => x.slot);
  const yName = state.normalize ? 'Events / min' : 'Events';

  const el = document.getElementById('timelineChart');
  if (!timelineChart) timelineChart = echarts.init(el, null, { renderer: 'canvas' });

  const area = state.timelineMode === 'stacked' ? { color: 'rgba(56,189,248,0.08)' } : null;
  const maybeStack = state.timelineMode === 'stacked' ? 'traffic' : null;

  const series = [
    {
      name: 'Attack', type: 'line', smooth: 0.25, symbol: 'none',
      stack: maybeStack,
      lineStyle: { width: 2, color: severity.critical },
      areaStyle: area,
      data: seriesFromTimeline(timeline, 'attacks')
    },
    {
      name: 'Connection', type: 'line', smooth: 0.25, symbol: 'none',
      stack: maybeStack,
      lineStyle: { width: 2, color: '#34d399' },
      areaStyle: area,
      data: seriesFromTimeline(timeline, 'connections')
    },
    {
      name: 'Web', type: 'line', smooth: 0.25, symbol: 'none',
      stack: maybeStack,
      lineStyle: { width: 2, color: '#38bdf8' },
      areaStyle: area,
      data: seriesFromTimeline(timeline, 'web')
    }
  ];

  if (state.compare && payload.compare) {
    series.push(
      {
        name: 'Prev Attack', type: 'line', smooth: 0.18, symbol: 'none',
        lineStyle: { width: 1.4, type: 'dashed', color: 'rgba(251,113,133,0.7)' },
        data: alignCompareTimeline(timeline, compareTimeline, 'attacks')
      },
      {
        name: 'Prev Connection', type: 'line', smooth: 0.18, symbol: 'none',
        lineStyle: { width: 1.4, type: 'dashed', color: 'rgba(52,211,153,0.75)' },
        data: alignCompareTimeline(timeline, compareTimeline, 'connections')
      }
    );
  }

  timelineChart.setOption({
    animationDuration: 380,
    grid: { top: 36, left: 42, right: 16, bottom: 54 },
    tooltip: { trigger: 'axis' },
    legend: { textStyle: { color: '#bcd1ee' }, top: 0 },
    xAxis: { ...commonAxis(), type: 'category', data: xSlots },
    yAxis: { ...commonAxis(), type: 'value', name: yName, nameTextStyle: { color: '#9fb3cf' } },
    dataZoom: [
      { type: 'inside', filterMode: 'none' },
      { type: 'slider', filterMode: 'none', height: 20, bottom: 24, borderColor: 'rgba(148,163,184,0.2)', textStyle: { color: '#9fb3cf' } }
    ],
    brush: { toolbox: ['lineX', 'clear'], xAxisIndex: 0, brushMode: 'single' },
    series
  }, true);
}

function clusterFlows(flows, step = 6) {
  const map = new Map();
  for (const x of (flows || [])) {
    const lat = Number(x.lat);
    const lon = Number(x.lon);
    if (!Number.isFinite(lat) || !Number.isFinite(lon)) continue;
    const key = `${Math.round(lat / step) * step}:${Math.round(lon / step) * step}:${x.country_name || 'Unknown'}`;
    const cur = map.get(key) || { ...x, count: 0, lat: 0, lon: 0, size: 0 };
    cur.count += Number(x.count || 0);
    cur.lat += lat * Number(x.count || 0);
    cur.lon += lon * Number(x.count || 0);
    cur.size += Number(x.count || 0);
    map.set(key, cur);
  }
  const out = [];
  for (const v of map.values()) {
    const denom = Math.max(1, v.size);
    out.push({ ...v, lat: v.lat / denom, lon: v.lon / denom, count: v.count });
  }
  return out.sort((a, b) => Number(b.count || 0) - Number(a.count || 0));
}

function applyCountryFilter(countryName, countryCode = '') {
  state.country = countryCode || countryName || '';
  state.ip = '';
  updateScopeChip();
  refreshAll();
}

function applyIpFilter(ip) {
  state.ip = ip || '';
  updateScopeChip();
  refreshAll();
}

function clearScopeFilters() {
  state.country = '';
  state.ip = '';
  updateScopeChip();
  refreshAll();
}

function mapSeriesPayload(countries, flowsConnection, flowsAttack, target) {
  const targetCoord = target && Number.isFinite(Number(target.lon)) && Number.isFinite(Number(target.lat))
    ? [Number(target.lon), Number(target.lat)]
    : [8.6821, 50.1109];
  const targetName = target?.name || 'Protected Server';

  const mapData = (countries || [])
    .filter(c => c.country_name && c.country_name !== 'Unknown' && c.country_name !== 'Private Network')
    .map(c => ({
      name: c.country_name,
      country_code: c.country_code,
      value: Number(c.count || 0),
      attacks: Number(c.attacks || 0)
    }));

  const flowConn = clusterFlows(flowsConnection || [], 7).slice(0, state.mapTopN);
  const flowAtk = clusterFlows(flowsAttack || [], 7).slice(0, state.mapTopN);

  const lineConn = flowConn.map(f => ({
    fromName: `${f.country_name} (${f.ip})`,
    toName: targetName,
    value: Number(f.count || 0),
    coords: [[Number(f.lon), Number(f.lat)], targetCoord],
    ip: f.ip,
    country: f.country_name,
    country_code: f.country_code
  }));

  const lineAtk = flowAtk.map(f => ({
    fromName: `${f.country_name} (${f.ip})`,
    toName: targetName,
    value: Number(f.count || 0),
    coords: [[Number(f.lon), Number(f.lat)], targetCoord],
    ip: f.ip,
    country: f.country_name,
    country_code: f.country_code
  }));

  const src = flowConn.map(f => ({
    name: `${f.country_name} (${f.ip})`,
    value: [Number(f.lon), Number(f.lat), Number(f.count || 0)],
    ip: f.ip,
    country: f.country_name,
    country_code: f.country_code
  }));

  return { mapData, lineConn, lineAtk, src, targetCoord, targetName };
}

function renderGeo(countries, flowsConnection = [], flowsAttack = [], target = null) {
  const payload = mapSeriesPayload(countries, flowsConnection, flowsAttack, target);
  const max = payload.mapData.reduce((m, x) => Math.max(m, x.value), 10);

  const el = document.getElementById('geoChart');
  if (!geoChart) geoChart = echarts.init(el, null, { renderer: 'canvas' });
  if (!echarts.getMap || !echarts.getMap('world')) {
    geoChart.setOption({
      title: {
        text: 'World map asset not loaded',
        left: 'center',
        top: 'middle',
        textStyle: { color: '#9fb3cf', fontSize: 13, fontWeight: 500 }
      }
    }, true);
    return;
  }

  const showArcs = state.mapMode === 'both' || state.mapMode === 'arcs';
  const showHeat = state.mapMode === 'both' || state.mapMode === 'heat';

  const series = [];
  if (showHeat) {
    series.push({ name: 'Geo Events', type: 'map', map: 'world', geoIndex: 0, data: payload.mapData });
    series.push({
      name: 'Heat', type: 'heatmap', coordinateSystem: 'geo',
      data: payload.src.map(s => ({ value: [s.value[0], s.value[1], s.value[2]], ip: s.ip, country: s.country, country_code: s.country_code })),
      pointSize: 8,
      blurSize: 14
    });
  }

  if (showArcs) {
    series.push({
      name: 'Connection Flow', type: 'lines', coordinateSystem: 'geo', zlevel: 2,
      effect: { show: true, period: 4, trailLength: 0.25, symbol: 'arrow', symbolSize: 8, color: '#22d3ee' },
      lineStyle: { color: 'rgba(34, 211, 238, 0.75)', width: 1.8, opacity: 0.85, curveness: 0.32 },
      data: payload.lineConn
    });
    series.push({
      name: 'Attack Flow', type: 'lines', coordinateSystem: 'geo', zlevel: 2,
      effect: { show: true, period: 4.8, trailLength: 0.2, symbol: 'arrow', symbolSize: 8, color: severity.critical },
      lineStyle: { color: 'rgba(251, 113, 133, 0.72)', width: 1.6, opacity: 0.82, curveness: 0.36 },
      data: payload.lineAtk
    });
    series.push({
      name: 'Flow Sources', type: 'effectScatter', coordinateSystem: 'geo', zlevel: 3,
      rippleEffect: { scale: 2.4, brushType: 'stroke' },
      symbolSize: (val) => Math.min(14, 5 + Number(val[2] || 0) * 0.2),
      itemStyle: { color: '#22d3ee' },
      data: payload.src
    });
  }

  series.push({
    name: 'Target', type: 'scatter', coordinateSystem: 'geo', zlevel: 4, symbol: 'diamond', symbolSize: 11,
    itemStyle: { color: '#f97316', shadowBlur: 12, shadowColor: 'rgba(249,115,22,.65)' },
    label: { show: true, formatter: payload.targetName, color: '#f8fafc', position: 'right', fontSize: 11 },
    data: [{ name: payload.targetName, value: payload.targetCoord }]
  });

  geoChart.setOption({
    geo: {
      map: 'world', roam: true, zoom: 1.15,
      itemStyle: { borderColor: 'rgba(148,163,184,0.25)', borderWidth: 0.7, areaColor: '#1f2937' },
      emphasis: { itemStyle: { areaColor: '#1d4ed8' }, label: { color: '#fff' } }
    },
    tooltip: {
      trigger: 'item',
      formatter: (p) => {
        const d = p.data || {};
        if (Array.isArray(d.coords)) return `${esc(d.fromName)} -> ${esc(d.toName)}<br>Events: ${Number(d.value || 0)}`;
        if (Array.isArray(d.value) && d.ip) return `${esc(d.country)}<br>IP: ${esc(d.ip)}<br>Events: ${Number(d.value[2] || 0)}`;
        return `${esc(p.name || d.country || 'Unknown')}<br>Events: ${Number(d.value || 0)}<br>Attacks: ${Number(d.attacks || 0)}`;
      }
    },
    visualMap: {
      min: 0,
      max,
      orient: 'horizontal',
      left: 8,
      bottom: 4,
      text: ['High', 'Low'],
      textStyle: { color: '#bcd1ee' },
      inRange: { color: ['#1e3a8a', '#0284c7', '#22d3ee', '#f59e0b', severity.critical] }
    },
    series
  }, true);

  geoChart.off('click');
  geoChart.on('click', (evt) => {
    const d = evt?.data || {};
    if (d.ip) {
      applyIpFilter(d.ip);
      return;
    }
    if (d.country_code || evt?.name) {
      applyCountryFilter(evt.name, d.country_code || '');
    }
  });
}

function startReplay() {
  stopReplay();
  if (!state.replay || !cache.geo?.country_timeline?.length) return;
  const slots = [...new Set(cache.geo.country_timeline.map(x => x.slot))];
  if (slots.length < 2) return;

  cache.replayIndex = 0;
  cache.replayTimer = setInterval(() => {
    cache.replayIndex = (cache.replayIndex + 1) % slots.length;
    const slot = slots[cache.replayIndex];
    const bySlot = (cache.geo.country_timeline || []).filter(x => x.slot === slot);
    const countries = bySlot.map(x => ({ country_code: x.country_code, country_name: x.country_name, count: x.count, attacks: x.attacks }));
    renderGeo(countries, cache.geo.flows_connection || [], cache.geo.flows_attack || [], cache.geo.target || null);
    document.getElementById('lastUpdate').textContent = `Replay: ${slot}`;
  }, 1400);
}

function stopReplay() {
  if (cache.replayTimer) {
    clearInterval(cache.replayTimer);
    cache.replayTimer = null;
  }
}

function renderAsn(topAsn) {
  const data = (topAsn || []).slice(0, 10).reverse();
  const el = document.getElementById('asnChart');
  if (!asnChart) asnChart = echarts.init(el, null, { renderer: 'canvas' });
  asnChart.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' },
      formatter: (items) => {
        const it = items[0] || {};
        const d = (it.data || {});
        return `${esc(d.label || '')}<br>Events: ${Number(d.value || 0)}<br>Attacks: ${Number(d.attacks || 0)}<br>IPs: ${Number(d.unique_ips || 0)}`;
      }
    },
    grid: { top: 12, left: 20, right: 20, bottom: 20, containLabel: true },
    xAxis: { ...commonAxis(), type: 'value' },
    yAxis: { ...commonAxis(), type: 'category', data: data.map(x => `${x.asn} ${String(x.as_org || '').slice(0, 20)}`) },
    series: [{
      type: 'bar',
      data: data.map(x => ({ value: Number(x.count || 0), label: `${x.asn} ${x.as_org}`, attacks: x.attacks, unique_ips: x.unique_ips })),
      showBackground: true,
      backgroundStyle: { color: 'rgba(148,163,184,.08)' },
      itemStyle: {
        borderRadius: [0, 6, 6, 0],
        color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [{ offset: 0, color: '#7dd3fc' }, { offset: 1, color: '#818cf8' }])
      }
    }]
  }, true);
}

function renderTopIps(topIps) {
  const data = (topIps || []).slice(0, 10).reverse();
  const el = document.getElementById('ipChart');
  if (!ipChart) ipChart = echarts.init(el, null, { renderer: 'canvas' });
  ipChart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: (p) => {
        const d = p.data || {};
        return `${esc(d.ip)}<br>Events: ${d.value}<br>Threat: ${d.threat_score}<br>ASN: ${esc(d.asn || '-')}`;
      }
    },
    grid: { top: 12, left: 20, right: 20, bottom: 20, containLabel: true },
    xAxis: { ...commonAxis(), type: 'value' },
    yAxis: { ...commonAxis(), type: 'category', data: data.map(x => x.ip) },
    series: [{
      type: 'bar',
      data: data.map(x => ({
        value: Number(x.count || 0),
        ip: x.ip,
        asn: x.asn,
        threat_score: Number(x.threat_score || 0),
        itemStyle: { color: threatColor(Number(x.threat_score || 0)), borderRadius: [0, 6, 6, 0] }
      }))
    }]
  }, true);

  ipChart.off('click');
  ipChart.on('click', (evt) => {
    if (!evt?.data?.ip) return;
    if (evt?.event?.event?.shiftKey) applyIpFilter(evt.data.ip);
    else openDrilldown(evt.data.ip);
  });
}

function renderRows(recent) {
  const rows = (recent || []).slice(0, 160);
  const tbody = document.getElementById('rows');
  tbody.innerHTML = rows.map(ev => {
    const score = Number(ev.threat_score || 0);
    const labels = (ev.threat_labels || []).join(', ');
    const cat = ev.category || 'info';
    return `
      <tr>
        <td class="mono">${esc(ev.ts)}</td>
        <td><span class="pill ${esc(cat)}">${esc(cat)}</span></td>
        <td><button class="ip-btn" data-country="${esc(ev.country_code)}" data-country-name="${esc(ev.country_name || '')}"><span class="country-cell">${flagIconHtml(ev.country_code, ev.country_name)}<span>${esc(ev.country_code)} ${esc(ev.country_name || '')}</span></span></button></td>
        <td class="mono"><button class="ip-btn" data-ip="${esc(ev.ip)}">${esc(ev.ip)}</button></td>
        <td title="${esc(ev.as_org || '')}">${esc(ev.asn || 'AS-UNK')}</td>
        <td title="${esc(labels)}"><span class="threat" style="background:${threatColor(score)}">${score}</span></td>
        <td>${esc(ev.action)}</td>
        <td title="${esc(ev.path)}">${esc(String(ev.path || '-').slice(0, 40))}</td>
        <td title="${esc(ev.user_agent || ev.ua_family)}">${esc(String(ev.ua_family || '-').slice(0, 32))}</td>
      </tr>
    `;
  }).join('');

  tbody.querySelectorAll('.ip-btn[data-ip]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const ip = btn.dataset.ip;
      if (e.shiftKey || e.ctrlKey || e.metaKey) applyIpFilter(ip);
      else openDrilldown(ip);
    });
  });

  tbody.querySelectorAll('.ip-btn[data-country]').forEach(btn => {
    btn.addEventListener('click', () => applyCountryFilter(btn.dataset.countryName, btn.dataset.country));
  });
}

function fmtTs(ts) {
  if (!ts) return '-';
  const d = new Date(ts);
  if (Number.isNaN(d.getTime())) return String(ts);
  return d.toLocaleString();
}

function renderBans(data) {
  cache.bans = data;
  const tbody = document.getElementById('banRows');
  const items = (data?.items || []).slice(0, 120);
  document.getElementById('banMeta').textContent = `Live: ${Number(data?.currently_banned || 0)} | Jail: ${data?.jail || 'sshd'}`;
  if (!items.length) {
    tbody.innerHTML = '<tr><td colspan="5" style="color:#9db0ca">Keine Ban-Daten vorhanden</td></tr>';
    return;
  }
  tbody.innerHTML = items.map(row => `
    <tr>
      <td class="mono">${esc(row.ip)}</td>
      <td><span class="status-pill ${row.is_currently_banned ? 'live' : 'old'}">${row.is_currently_banned ? 'BANNED' : 'HISTORY'}</span></td>
      <td>${esc(fmtTs(row.last_banned_at))}</td>
      <td>${Number(row.ban_count || 0)}</td>
      <td>${row.is_currently_banned ? `<button class="btn-mini" data-unban="${esc(row.ip)}">Unban</button>` : '-'}</td>
    </tr>
  `).join('');

  tbody.querySelectorAll('button[data-unban]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const ip = btn.getAttribute('data-unban');
      if (!ip) return;
      btn.disabled = true;
      btn.textContent = '...';
      try {
        const res = await fetch('/api/unban', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip, jail: 'sshd' })
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok || !payload.ok) {
          alert('Unban fehlgeschlagen: ' + (payload.error || res.status));
        } else {
          await Promise.all([fetchSummary(), fetchBans()]);
        }
      } catch (e) {
        alert('Unban Fehler');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Unban';
      }
    });
  });
}

function deltaString(current, previous) {
  const cur = Number(current || 0);
  const prev = Number(previous || 0);
  const diff = cur - prev;
  const sign = diff > 0 ? '+' : '';
  return `${cur} (${sign}${diff})`;
}

function applySummary(data) {
  cache.summary = data;
  if (state.compare && data.compare) {
    setText('kAttacks', deltaString(data.totals?.attacks, data.compare.totals?.attacks));
    setText('kConnections', deltaString(data.totals?.connections, data.compare.totals?.connections));
    setText('kBans', deltaString(data.totals?.bans, data.compare.totals?.bans));
    setText('kSources', deltaString(data.totals?.active_sources, data.compare.totals?.active_sources));
    setText('kWeb', deltaString(data.totals?.web_requests, data.compare.totals?.web_requests));
  } else {
    setText('kAttacks', data.totals?.attacks || 0);
    setText('kConnections', data.totals?.connections || 0);
    setText('kBans', data.totals?.bans || 0);
    setText('kSources', data.totals?.active_sources || 0);
    setText('kWeb', data.totals?.web_requests || 0);
  }

  const maxThreat = Math.max(0, ...(data.top_ips || []).map(x => Number(x.threat_score || 0)));
  setText('kThreat', maxThreat);

  const topAsn = (data.top_ips || []).find(x => x.asn && x.asn !== 'AS-UNK');
  setText('kAsn', topAsn ? topAsn.asn : 'AS-UNK');

  if (!state.replay) {
    document.getElementById('lastUpdate').textContent = 'Update: ' + new Date(data.generated_at).toLocaleTimeString();
  }

  renderTimeline(data);
  renderTopIps(data.top_ips || []);
  renderRows(data.recent || []);
}

function applyGeo(data) {
  cache.geo = data;
  if (!state.replay) {
    renderGeo(data.countries || [], data.flows_connection || data.flows || [], data.flows_attack || [], data.target || null);
  }
  renderAsn(data.top_asn || []);
  startReplay();
}

async function fetchSummary() {
  const res = await fetch(summaryUrl());
  if (!res.ok) return;
  const data = await res.json();
  applySummary(data);
}

async function fetchGeo() {
  const res = await fetch(geoUrl());
  if (!res.ok) return;
  const data = await res.json();
  applyGeo(data);
}

async function fetchBans() {
  const res = await fetch(bansUrl());
  if (!res.ok) return;
  const data = await res.json();
  renderBans(data);
}

async function refreshAll() {
  stopReplay();
  await Promise.all([fetchSummary(), fetchGeo(), fetchBans()]);
}

function listToText(items, formatter) {
  if (!items || !items.length) return '-';
  return items.map((x, i) => `${i + 1}. ${formatter(x)}`).join('\n');
}

function ensureDrawerCharts() {
  if (!dTimelineChart) dTimelineChart = echarts.init(document.getElementById('dTimeline'), null, { renderer: 'canvas' });
  if (!dActionsChart) dActionsChart = echarts.init(document.getElementById('dActions'), null, { renderer: 'canvas' });
  if (!dStatusChart) dStatusChart = echarts.init(document.getElementById('dStatus'), null, { renderer: 'canvas' });
}

function renderDrilldownCharts(data) {
  ensureDrawerCharts();

  dTimelineChart.setOption({
    grid: { top: 16, left: 36, right: 16, bottom: 28 },
    tooltip: { trigger: 'axis' },
    xAxis: { ...commonAxis(), type: 'category', data: (data.timeline || []).map(x => x.slot) },
    yAxis: { ...commonAxis(), type: 'value' },
    series: [
      { type: 'line', name: 'Total', smooth: 0.2, symbol: 'none', data: (data.timeline || []).map(x => x.total), lineStyle: { color: '#38bdf8' } },
      { type: 'line', name: 'Attack', smooth: 0.2, symbol: 'none', data: (data.timeline || []).map(x => x.attacks), lineStyle: { color: severity.critical } }
    ]
  }, true);

  dActionsChart.setOption({
    tooltip: { trigger: 'item' },
    series: [{
      type: 'pie',
      radius: ['36%', '70%'],
      label: { color: '#bcd1ee', formatter: '{b}: {d}%' },
      data: (data.top_actions || []).map(x => ({ name: x.action, value: Number(x.count || 0) }))
    }]
  }, true);

  dStatusChart.setOption({
    grid: { top: 16, left: 28, right: 16, bottom: 24, containLabel: true },
    tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
    xAxis: { ...commonAxis(), type: 'category', data: (data.status_breakdown || []).map(x => String(x.status)) },
    yAxis: { ...commonAxis(), type: 'value' },
    series: [{ type: 'bar', data: (data.status_breakdown || []).map(x => Number(x.count || 0)), itemStyle: { color: '#22d3ee', borderRadius: [6,6,0,0] } }]
  }, true);
}

async function openDrilldown(ip) {
  if (!ip || ip === '-') return;
  const res = await fetch('/api/ip/' + encodeURIComponent(ip) + '?hours=168');
  if (!res.ok) return;
  const data = await res.json();

  document.getElementById('drawer').classList.add('open');
  document.getElementById('drawer').setAttribute('aria-hidden', 'false');

  setText('dIp', data.ip || ip);
  setText('dMeta', `${data.enrichment?.country_name || '-'} | ${data.enrichment?.asn || '-'} ${data.enrichment?.as_org || ''}`);
  setText('dTotal', data.totals?.total || 0);
  setText('dAttacks', data.totals?.attacks || 0);
  setText('dBans', data.totals?.bans || 0);
  setText('dThreat', data.enrichment?.threat_score || 0);

  document.getElementById('dPaths').textContent = listToText(data.top_paths, x => `${x.path} (${x.count})`);
  document.getElementById('dUa').textContent = listToText(data.top_ua, x => `${x.ua_family} [${x.ua_device}] (${x.count})`);
  document.getElementById('dLabels').textContent = (data.enrichment?.threat_labels || []).join(', ') || '-';

  renderDrilldownCharts(data);
}

function connectStream() {
  const es = new EventSource('/api/stream');
  es.onmessage = (evt) => {
    try {
      if (state.hours !== 24 || state.category !== 'all' || state.q || state.compare || state.normalize || state.country || state.ip) return;
      const data = JSON.parse(evt.data);
      applySummary(data);
    } catch (_) {}
  };
  es.onerror = () => {
    es.close();
    setTimeout(connectStream, 4500);
  };
}

function resizeCharts() {
  [timelineChart, geoChart, asnChart, ipChart, dTimelineChart, dActionsChart, dStatusChart].forEach(ch => {
    if (ch) ch.resize();
  });
}

function syncControlsToState() {
  document.getElementById('compareToggle').checked = state.compare;
  document.getElementById('normalizeToggle').checked = state.normalize;
  document.getElementById('timelineMode').value = state.timelineMode;
  document.getElementById('mapMode').value = state.mapMode;
  document.getElementById('mapTopN').value = String(state.mapTopN);
  document.getElementById('replayToggle').checked = state.replay;
}

window.addEventListener('resize', resizeCharts);
document.getElementById('refreshBtn').addEventListener('click', refreshAll);
document.getElementById('closeDrawer').addEventListener('click', () => {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawer').setAttribute('aria-hidden', 'true');
});
document.getElementById('applyBtn').addEventListener('click', () => {
  state.category = document.getElementById('category').value;
  state.hours = Number(document.getElementById('window').value);
  state.q = document.getElementById('search').value.trim();
  refreshAll();
});

document.getElementById('search').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') document.getElementById('applyBtn').click();
});

document.getElementById('compareToggle').addEventListener('change', (e) => {
  state.compare = !!e.target.checked;
  refreshAll();
});
document.getElementById('normalizeToggle').addEventListener('change', (e) => {
  state.normalize = !!e.target.checked;
  if (cache.summary) applySummary(cache.summary);
});
document.getElementById('timelineMode').addEventListener('change', (e) => {
  state.timelineMode = e.target.value;
  if (cache.summary) renderTimeline(cache.summary);
});
document.getElementById('mapMode').addEventListener('change', (e) => {
  state.mapMode = e.target.value;
  if (cache.geo && !state.replay) renderGeo(cache.geo.countries || [], cache.geo.flows_connection || [], cache.geo.flows_attack || [], cache.geo.target || null);
});
document.getElementById('mapTopN').addEventListener('change', (e) => {
  state.mapTopN = Number(e.target.value || 50);
  refreshAll();
});
document.getElementById('replayToggle').addEventListener('change', (e) => {
  state.replay = !!e.target.checked;
  if (!state.replay && cache.geo) {
    stopReplay();
    renderGeo(cache.geo.countries || [], cache.geo.flows_connection || [], cache.geo.flows_attack || [], cache.geo.target || null);
    document.getElementById('lastUpdate').textContent = 'Update: ' + new Date().toLocaleTimeString();
    return;
  }
  startReplay();
});

document.getElementById('activeFilter').addEventListener('dblclick', clearScopeFilters);

updateScopeChip();
syncControlsToState();
refreshAll();
connectStream();
setInterval(() => {
  if (document.hidden) return;
  refreshAll();
}, 20000);
</script>
</body>
</html>
